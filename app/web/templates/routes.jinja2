{% extends "_layout.jinja2" %}

{% block content %}
<h1>Routes</h1>

<!-- List of existing routes -->
<table>
    <thead>
        <tr>
            <th>Domain</th>
            <th>Path</th>
            <th>Hosts</th>
            <th>Backend Path</th>
            <th>Active</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for route in routes %}
        <tr>
            <td style="text-align: right;">{{ route.subdomain }}.{{ route.domain.name }}</td>
            <td>{{ route.path_prefix }}</td>
            <td>
                {% for host in route.hosts %}
                    {{ route.protocol | lower }}://{{ host.host }}<br>
                {% endfor %}
            </td>
            <td>{{ route.backend_path }}</td>
            <td>
                <a href="{{ url_for('toggle_route', route_id=route.id) }}">
                    {{ route.active }}
                </a>
            </td>
            <td>
                <a href="{{ url_for('edit_route', route_id=route.id) }}">Edit</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7">No routes found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Form to add a new route -->
<h2>Add New Route</h2>
<form method="post" action="{{ url_for('create_route') }}">
    <div>
        <label for="subdomain">Subdomain:</label>
        <input type="text" id="subdomain" name="subdomain">
    </div>
    <div>
        <label for="domain_id">Domain:</label>
        <select id="domain_id" name="domain_id">
            {% for domain in domains %}
            <option value="{{ domain.id }}">{{ domain.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label for="protocol">Protocol:</label>
        <select id="protocol" name="protocol">
            {% for proto in protocols %}
            <option value="{{ proto }}">{{ proto }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label for="path_prefix">Path:</label>
        <input type="text" id="path_prefix" name="path_prefix" value="/">
    </div>
    <div>
        <label for="backend_path">Backend Path:</label>
        <input type="text" id="backend_path" name="backend_path">
    </div>
    <button type="submit">Add Route</button>
</form>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const protocolSelect = document.getElementById('protocol');
    const pathPrefixInput = document.getElementById('path_prefix');
    const pathPrefixLabel = document.querySelector('label[for="path_prefix"]');
    const backendPathDiv = document.querySelector('div:has(> #backend_path)');
    const originalLabel = "Path:";
    
    // Function to update the path field based on selected protocol
    function updatePathField() {
        const isStream = protocolSelect.value === 'STREAM';
        
        // Update label and input behavior
        if (isStream) {
            pathPrefixLabel.textContent = "Listen Port:";
            pathPrefixInput.setAttribute('placeholder', 'Port number (e.g. 8080)');
            pathPrefixInput.setAttribute('type', 'number');
            pathPrefixInput.setAttribute('min', '1');
            pathPrefixInput.setAttribute('max', '65535');
            
            // Remove any leading slash if present
            if (pathPrefixInput.value.startsWith('/')) {
                pathPrefixInput.value = pathPrefixInput.value.substring(1);
            } else if (pathPrefixInput.value === '/') {
                // Default value for stream is empty (will be validated on submit)
                pathPrefixInput.value = '';
            }
            
            // Hide backend path for STREAM
            backendPathDiv.style.display = 'none';
        } else {
            pathPrefixLabel.textContent = originalLabel;
            pathPrefixInput.setAttribute('placeholder', 'Path prefix (e.g. /api)');
            pathPrefixInput.setAttribute('type', 'text');
            pathPrefixInput.removeAttribute('min');
            pathPrefixInput.removeAttribute('max');
            
            // Add leading slash if not present and not empty
            if (pathPrefixInput.value && !pathPrefixInput.value.startsWith('/')) {
                pathPrefixInput.value = '/' + pathPrefixInput.value;
            } else if (pathPrefixInput.value === '') {
                // Default value for HTTP is '/'
                pathPrefixInput.value = '/';
            }
            
            // Show backend path for other protocols
            backendPathDiv.style.display = '';
        }
    }
    
    // Initialize on page load
    updatePathField();
    
    // Update when protocol changes
    protocolSelect.addEventListener('change', updatePathField);
    
    // Validate form before submission
    document.querySelector('form').addEventListener('submit', function(e) {
        if (protocolSelect.value === 'STREAM') {
            const port = parseInt(pathPrefixInput.value);
            if (isNaN(port) || port < 1 || port > 65535) {
                e.preventDefault();
                alert('For STREAM protocol, please enter a valid port number (1-65535)');
            }
        }
    });
});
</script>
{% endblock %}